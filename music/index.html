<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="referrer" content="no-referrer">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>my music</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>

<div class="music-box">
    <!--<i class="music-icon music-list">&#xe61a;</i>-->
    <div class="img-filter"></div>
    <div class="layer-ct"></div>
    <img src="https://misc.360buyimg.com/mtd/pc/index/gb/images/lazyload@2x.gif" class="picture" id="picture">
    <div class="music-content">
        <i class="music-icon lyric-like-share lyric">&#xe629;</i>
        <i class="music-icon lyric-like-share like">&#xe601;</i>
        <i class="music-icon lyric-like-share share">&#xe624;</i>
        <div class="album-box"></div>
        <div class="lyric-box"></div>
        <div class="player-box">
            <div class="progress">
                <div class="progress-line">
                    <s class="progress-handle"></s>
                </div>
            </div>
            <span class="time current-time">0:00</span>
            
            <!--<i class="music-icon p-n-btn out-type">&#xe871;</i>-->
            <!--<i class="music-icon p-n-btn out-type">&#xe66d;</i>-->
            <i class="music-icon play-btn">&#xe6ee;</i>
            <i class="music-icon p-n-btn next">&#xe718;</i>
            <i class="music-icon p-n-btn out-type">&#xe67c;</i>
            <i class="music-icon vol">&#xe63d;</i>
            <div class="volume-bar">
                <span class="volume-line">
                    <span class="volume-handle"></span>
                </span>
            </div>
            <span class="time duration-time">0:00</span>
    </div>
    </div>
</div>
<audio src="" id="audio" autoplay>您的浏览器不支持 audio 标签。</audio>
<script src="https://cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script>
<script>    
var sid = '';
var fmUrl = 'https://jirenguapi.applinzi.com/fm/';
var audio = $('#audio')[0];
var lyricBox = $('.lyric-box');


function getSong(){
    $.get(fmUrl+"getSong.php", {channel: 'public_shiguang_80hou'},function (data) {
        if(data.song[0].url === null && data.song[0].artist === null && data.song[0].title === null){
            getSong();
        }else{
            var musicName = '<h3>'+data.song[0].title+'</h3><p>演唱者：'+data.song[0].artist+' </p><p>来源：80后音乐榜单</p>';
            $('#audio').attr({'src': data.song[0].url , 'autoplay':'true'});
            $('.album-box').html(musicName);
            $('#picture').attr('src', data.song[0].picture);
            $('.img-filter').css('backgroundImage', 'url('+data.song[0].picture+')');
            sid = data.song[0].sid;
            audio.volume = '0.7';
            createArrMap()
        }
    },'jsonp');
}

getSong();



// 获取歌词
function createArrMap() {
    var lyricArr = [];
    $.post(fmUrl+"getLyric.php", {sid: sid },function (data) {
        var lyric = JSON.parse(data).lyric;
        var lines = lyric.split('\n'),  // 把歌词以空格分开
            timeRegular = /\[\d{2}:\d{2}.\d{2}\]/g;   // 匹配时间
        lines.forEach(function (i) {
            if (!timeRegular.test(i)) {              //剔除收到数据中没有时间的部分
                lines.splice(i, 1);
                return;
            }
            var time = i.match(timeRegular);       //把歌词分为：时间和歌词两个部分
            var lyric = i.split(time);
            var seconds = time[0][1] * 600 + time[0][2] * 60 + time[0][4] * 10 + time[0][5] * 1;  //将时间换算为秒
            lyricArr.push([seconds, lyric[1]] );      //将整个歌词保存至二维数组中，形式为[时间，歌词]；     
        });
        readyLyric(lyricArr);
    });
}

// 点击获取歌词
var ly = true;
$('.lyric').on('click', function(){
    if(ly){
        $('.music-box').addClass('active');
        ly = false;
    }else{
        $('.music-box').removeClass('active');
        ly = true;
    }
})


function readyLyric(lyric){
    lyricBox.empty();
    var lyricLength = 0;
    var html = '<div class="lyric-ani" data-height="20">';
    lyric.forEach(function(element,index) {
        var ele = element[1] === undefined ? '^_^歌词错误^_^' :  element[1];
        html += '<p class="lyric-line" data-id="'+index+'" data-time="' + element[0] + '">&nbsp;' +  ele + '&nbsp;</p>';
        lyricLength++;
    });
    html += '</div>';
    

    lyricBox.append(html);

    // 歌词高度 第一个p清空
    var lyricH = $('.lyric-ani').data('height'),
        lyricP = lyricBox.find('.lyric-ani p');
    lyricP.eq(0).html("&nbsp;&nbsp;");
    var curTime = audio.currentTime;
    var content = audio.duration; //写里面

  audio.ontimeupdate = function(){
      

        if(isNaN(content)){ content = audio.duration;  }
        
        for (var i = 0; i < lyricLength; i++) {                          //遍历歌词下所有的li
            var curT = lyricP.eq(i).data("time");      //获取当前li存入的当前一排歌词时间
            var nexT = lyricP.eq(i + 1).data("time");
            var curTime = audio.currentTime; 
            if(curTime > nexT){
                lyricP.removeClass('active');
                $('.lyric-ani').css({
                    'height': lyricH*lyricLength+'px',
                    'marginTop': - parseInt(lyricH * i - 100)+'px',
                    "transition": "6s"
                });
            }
            if( (curTime > curT) && (curTime < nexT)){
                lyricP.eq( i ).addClass("active");
            }
        }
  
        if(parseInt(content - (parseInt(content / 60) * 60)) < 10) {
            $('.duration-time').text(parseInt(content / 60) + ':0' + parseInt(content - (parseInt(content / 60) * 60)));
        } else {
            $('.duration-time').text(parseInt(content / 60) + ':' + parseInt(content- (parseInt(content / 60) * 60)));
        }

        if( parseInt(curTime - (parseInt(curTime/ 60) * 60)) < 10 ){
            $('.current-time').text(parseInt(curTime / 60) + ':0' + parseInt(curTime - (parseInt(curTime/ 60) * 60)))
        }else{
            $('.current-time').text(parseInt(curTime / 60) + ':' + parseInt(curTime - (parseInt(curTime/ 60) * 60)))
        }

        var length = curTime / content * 100;
        $('.progress-line').css({
            "width" : length +'%'
        });

        audio.onended = function() {
            getSong();
        };
  }
}
 
// 下一曲
 $('.next').on('click', function(){
     getSong();
 })
// 暂停
$('.play-btn ').on('click', function(){
    if (audio.paused) {
        audio.play();
        $('.play-btn').html('&#xe6ee;');
    } else {
        audio.pause();
        $('.play-btn').html('&#xe602;')
    }
});
// 喜欢
var like = true;
$('.like').on('click', function(){
 if(like){
        $('.like').html('&#xe60a;');
        like = false;
    }else{
        $('.like').html('&#xe601;');
        like = true;
    }
})
// 设置声音
$('.volume-bar').on('mousemove', function(e){
    var len = $(this).width();
    var left = e.pageX - $(this).offset().left;
    var volume = left / len;
   
    if(left > 0 && left <= len){
        $('.volume-line').css('width', volume * 100 +'%');
        audio.volume = volume;
    }
    if(volume > 0.5){
        $('.vol').html('&#xe63d');
    }else if(volume < 0.5 && volume > 0.1 ){
        $('.vol').html('&#xe63c');
    }else{
        $('.vol').html('&#xe63b');
    }

})

// 设置音乐进度
$('.progress').on('click', function(e){
    var len = $(this).width(),
        left = e.pageX - $(this).offset().left,
        volume = left / len;

    if(volume <= 1 || volume >= 0){
        audio.currentTime =  volume * audio.duration;
         $('.progress-line').css('width', volume *100 +'%');
    }
});


// 拖拽音乐进度条
var btn = $('.progress-handle');
var clicking = false;
btn.mousedown(function(){
    clicking = true;
    audio.pause();
});
btn.mouseup(function(){
    clicking = false;
    audio.play();
});
$('.progress').mousemove(function(e){
    if(clicking == false) return;
    var len = $(this).width(),
        left = e.pageX - $(this).offset().left,
        volume = left / len;
    if(volume <= 1 || volume >= 0){
        audio.currentTime =  volume * audio.duration;
         $('.progress-line').css('width', volume *100 +'%');
    }
});
</script>
</body>
</html>